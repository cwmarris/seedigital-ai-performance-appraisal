<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>seedigital.AI Performance Appraisal System</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Microsoft Graph SDK for SharePoint integration -->
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f9fb; 
        }
        
        .card { 
            background-color: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); 
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .btn-primary { 
            background-color: #10b981; 
            color: white; 
            transition: background-color 0.2s; 
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary:hover { 
            background-color: #059669; 
        }
        
        .btn-secondary { 
            background-color: #f3f4f6; 
            color: #1f2937; 
            transition: background-color 0.2s; 
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-secondary:hover { 
            background-color: #e5e7eb; 
        }
        
        .btn-blue { 
            background-color: #3b82f6; 
            color: white; 
            transition: background-color 0.2s; 
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-blue:hover { 
            background-color: #2563eb; 
        }
        
        .input-style { 
            border: 1px solid #d1d5db; 
            padding: 10px; 
            border-radius: 8px; 
            width: 100%; 
            transition: border-color 0.2s, box-shadow 0.2s; 
        }
        
        .input-style:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); 
            outline: none; 
        }
        
        textarea { 
            resize: vertical; 
            min-height: 100px;
        }
        
        .competency-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
        }
        
        .ai-suggestion {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-top: 0.5rem;
            border-radius: 4px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .rating-scale {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .rating-btn {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .rating-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .rating-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .logo-seeo {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e40af;
            font-family: 'Inter', sans-serif;
            text-transform: lowercase;
            position: relative;
            display: inline-block;
        }
        
        .logo-tm {
            font-size: 0.8rem;
            color: #f97316;
            position: absolute;
            top: -0.15rem;
            right: -1rem;
            font-weight: 400;
            line-height: 1;
        }
        
        .logo-know {
            font-size: 1.1rem;
            font-weight: 700;
            color: #f97316;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: -0.25rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Logo -->
        <div class="logo-container mb-4">
            <div class="logo-seeo">
                seeo<span class="logo-tm">â„¢</span>
            </div>
            <div class="logo-know">KNOW</div>
        </div>
        
        <!-- Header -->
        <div class="card mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Performance Appraisal System</h1>
                    <p class="text-gray-600 mt-2">seedigital.ai Staff Performance Review</p>
                </div>
                <div class="flex gap-3">
                    <button id="saveDraftBtn" class="btn-secondary" onclick="saveDraft()">
                        <i data-lucide="save" class="inline-block w-4 h-4 mr-2"></i>
                        Save Draft
                    </button>
                    <button id="shareBtn" class="btn-blue" onclick="shareAppraisal()">
                        <i data-lucide="share-2" class="inline-block w-4 h-4 mr-2"></i>
                        Share Link
                    </button>
                    <button id="emailBtn" class="btn-blue" onclick="sendEmailNotification()">
                        <i data-lucide="mail" class="inline-block w-4 h-4 mr-2"></i>
                        Email Link
                    </button>
                    <button id="saveBtn" class="btn-primary" onclick="saveToSharePoint()">
                        <i data-lucide="cloud-upload" class="inline-block w-4 h-4 mr-2"></i>
                        Save to SharePoint
                    </button>
                    <button id="exportAuditBtn" class="btn-secondary" onclick="exportForSOC2Audit()" style="background-color: #8b5cf6; color: white;">
                        <i data-lucide="file-text" class="inline-block w-4 h-4 mr-2"></i>
                        Export for SOC 2 Audit
                    </button>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center gap-4">
                    <div>
                        <span class="text-sm text-gray-600">Appraisal ID:</span>
                        <span id="appraisalId" class="text-sm font-mono font-semibold text-blue-600 ml-2"></span>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span id="lastSaved" class="italic"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Information -->
        <div class="card">
            <h2 class="section-header">Employee Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Employee Name</label>
                    <input type="text" id="employeeName" class="input-style" placeholder="Enter employee name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Employee ID</label>
                    <input type="text" id="employeeId" class="input-style" placeholder="Enter employee ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <input type="text" id="department" class="input-style" placeholder="Enter department">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Manager Name</label>
                    <input type="text" id="managerName" class="input-style" placeholder="Enter manager name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Review Period</label>
                    <input type="text" id="reviewPeriod" class="input-style" placeholder="e.g., Jan 2024 - Jun 2024" value="Jan 2024 - Jun 2024">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Review Date</label>
                    <input type="date" id="reviewDate" class="input-style">
                </div>
            </div>
        </div>

        <!-- Self-Assessment: Core Competencies -->
        <div class="card">
            <h2 class="section-header">Self-Assessment: Core Competencies</h2>
            <p class="text-gray-600 mb-4">Rate yourself across the following core competencies (1-5 scale: 1=Needs Improvement, 5=Exceeds Expectations)</p>
            
            <div id="competenciesContainer">
                <!-- Competencies will be dynamically added here -->
            </div>
            
            <button class="btn-secondary mt-4" id="addCompetencyBtn" type="button" onclick="console.log('Button clicked!'); try { if(window.addCompetency) { window.addCompetency(); } else if(window._addCompetency) { window._addCompetency(); } else { alert('Function not found. Please refresh.'); } } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); } return false;">
                <i data-lucide="plus" class="inline-block w-4 h-4 mr-2"></i>
                Add Competency
            </button>
        </div>

        <!-- Self-Reflection: Previous 6 Months -->
        <div class="card">
            <h2 class="section-header">Self-Reflection: Previous 6 Months</h2>
            <p class="text-gray-600 mb-4">Reflect on your performance, achievements, and areas for growth over the past 6 months.</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Key Achievements</label>
                <textarea id="keyAchievements" class="input-style" placeholder="Describe your key achievements and accomplishments..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('keyAchievements', 'What are your key achievements from the past 6 months?')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="keyAchievements-AI" class="ai-suggestion hidden"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Challenges and Learnings</label>
                <textarea id="challengesLearnings" class="input-style" placeholder="Describe challenges faced and key learnings..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('challengesLearnings', 'What challenges did you face and what did you learn?')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="challengesLearnings-AI" class="ai-suggestion hidden"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Areas for Improvement</label>
                <textarea id="areasForImprovement" class="input-style" placeholder="Identify areas where you would like to improve..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('areasForImprovement', 'What areas would you like to improve?')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="areasForImprovement-AI" class="ai-suggestion hidden"></div>
            </div>
        </div>

        <!-- Performance Goals: Next 6 Months -->
        <div class="card">
            <h2 class="section-header">Performance Goals: Next 6 Months</h2>
            <p class="text-gray-600 mb-4">Define your performance goals and objectives for the next 6 months.</p>
            
            <div id="goalsContainer">
                <!-- Goals will be dynamically added here -->
            </div>
            
            <button class="btn-secondary mt-4" id="addGoalBtn" type="button" onclick="console.log('Button clicked!'); try { if(window.addGoal) { window.addGoal(); } else if(window._addGoal) { window._addGoal(); } else { alert('Function not found. Please refresh.'); } } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); } return false;">
                <i data-lucide="plus" class="inline-block w-4 h-4 mr-2"></i>
                Add Goal
            </button>
        </div>

        <!-- Manager Assessment -->
        <div class="card" id="managerAssessment">
            <h2 class="section-header">Manager Assessment</h2>
            <p class="text-gray-600 mb-4">Manager's evaluation and feedback (to be completed by manager).</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Overall Performance Rating</label>
                <div class="rating-scale" id="managerRatingScale">
                    <button class="rating-btn" onclick="setManagerRating(1)">1 - Needs Improvement</button>
                    <button class="rating-btn" onclick="setManagerRating(2)">2 - Below Expectations</button>
                    <button class="rating-btn" onclick="setManagerRating(3)">3 - Meets Expectations</button>
                    <button class="rating-btn" onclick="setManagerRating(4)">4 - Above Expectations</button>
                    <button class="rating-btn" onclick="setManagerRating(5)">5 - Exceeds Expectations</button>
                </div>
                <input type="hidden" id="managerRating" value="">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Manager's Feedback on Core Competencies</label>
                <textarea id="managerCompetencyFeedback" class="input-style" placeholder="Provide feedback on each core competency..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('managerCompetencyFeedback', 'Help me write feedback on employee competencies')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="managerCompetencyFeedback-AI" class="ai-suggestion hidden"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Strengths</label>
                <textarea id="managerStrengths" class="input-style" placeholder="Identify employee strengths..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('managerStrengths', 'Help me identify employee strengths')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="managerStrengths-AI" class="ai-suggestion hidden"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Development Areas</label>
                <textarea id="managerDevelopmentAreas" class="input-style" placeholder="Identify areas for development..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('managerDevelopmentAreas', 'Help me identify areas for employee development')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="managerDevelopmentAreas-AI" class="ai-suggestion hidden"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Recommendations for Next 6 Months</label>
                <textarea id="managerRecommendations" class="input-style" placeholder="Provide recommendations for the next review period..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('managerRecommendations', 'Help me write recommendations for the next 6 months')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="managerRecommendations-AI" class="ai-suggestion hidden"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Manager's Signature</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="managerSignature" class="input-style" placeholder="Manager name">
                    <input type="date" id="managerSignatureDate" class="input-style">
                </div>
            </div>
        </div>

        <!-- Employee Acknowledgment -->
        <div class="card">
            <h2 class="section-header">Employee Acknowledgment</h2>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="employeeAcknowledgment" class="mr-2 w-5 h-5">
                    <span class="text-gray-700">I acknowledge that I have reviewed this performance appraisal and discussed it with my manager.</span>
                </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="employeeSignature" class="input-style" placeholder="Employee name">
                <input type="date" id="employeeSignatureDate" class="input-style">
            </div>
        </div>

        <!-- Comprehensive AI Assessment Section -->
        <div class="card bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="section-header text-blue-800">
                    <i data-lucide="sparkles" class="inline-block w-6 h-6 mr-2 text-blue-600"></i>
                    AI Performance Assessment
                </h2>
            </div>
            <p class="text-gray-700 mb-4">
                Get comprehensive AI feedback on your entire performance appraisal. The AI will review both employee and manager sections, 
                provide suggestions for improvement, and help you enhance your responses. You can rerun the assessment multiple times to 
                refine your appraisal.
            </p>
            
            <div class="mb-4">
                <button id="runAIAssessmentBtn" class="btn-blue w-full md:w-auto" onclick="runComprehensiveAIAssessment()">
                    <i data-lucide="sparkles" class="inline-block w-5 h-5 mr-2"></i>
                    Run AI Assessment
                </button>
                <button id="rerunAIAssessmentBtn" class="btn-secondary w-full md:w-auto ml-2 hidden" onclick="runComprehensiveAIAssessment()">
                    <i data-lucide="refresh-cw" class="inline-block w-5 h-5 mr-2"></i>
                    Rerun Assessment
                </button>
            </div>
            
            <div id="aiAssessmentLoading" class="hidden mb-4 p-4 bg-white rounded-lg border border-blue-200">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                    <span class="text-gray-700">AI is analyzing your performance appraisal...</span>
                </div>
            </div>
            
            <div id="aiAssessmentResults" class="hidden bg-white rounded-lg border border-blue-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Assessment Results</h3>
                    <button onclick="document.getElementById('aiAssessmentResults').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="aiAssessmentContent" class="space-y-6 text-gray-700">
                    <!-- Assessment content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Save Status -->
        <div id="saveStatus" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            <span id="saveStatusText">Saved successfully!</span>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Microsoft Azure AD / MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: 'YOUR_CLIENT_ID', // Replace with your Azure AD App Registration Client ID
                authority: 'https://login.microsoftonline.com/YOUR_TENANT_ID', // Replace with your tenant ID
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            }
        };

        // Initialize MSAL only if it's available (lazy initialization)
        let msalInstance = null;
        if (typeof msal !== 'undefined' && msal.PublicClientApplication) {
            msalInstance = new msal.PublicClientApplication(msalConfig);
        } else {
            console.warn('MSAL library not loaded. SharePoint integration will not work until MSAL is loaded.');
        }

        // SharePoint Configuration
        // Configured for seedigital.ai SharePoint site
        const sharePointConfig = {
            // SharePoint site URL
            // Site: seeo (seedigital.ai SharePoint)
            siteUrl: 'https://seedigitalai.sharepoint.com/sites/seeo',
            
            // The document library name where appraisals will be saved
            // This is typically 'Shared Documents' or 'Documents' in SharePoint
            libraryName: 'Shared Documents',
            
            // Folder path within the document library
            // This corresponds to the SharePoint folder where completed appraisals are stored
            // Folder link: https://seedigitalai.sharepoint.com/:f:/s/seeo/EujwM32aUu9CpUawVBHjoNEBpxH3VSbQohz9ewEicUp-kg?e=WZz1Ys
            // For Graph API, we'll use the folder ID or navigate to the folder
            folderPath: '', // Will be set dynamically based on folder ID if needed
            
            // Folder ID from SharePoint link (for direct access)
            // Extracted from: https://seedigitalai.sharepoint.com/:f:/s/seeo/EujwM32aUu9CpUawVBHjoNEBpxH3VSbQohz9ewEicUp-kg?e=WZz1Ys
            folderId: 'EujwM32aUu9CpUawVBHjoNEBpxH3VSbQohz9ewEicUp-kg',
            
            // Direct folder link for user reference
            folderLink: 'https://seedigitalai.sharepoint.com/:f:/s/seeo/EujwM32aUu9CpUawVBHjoNEBpxH3VSbQohz9ewEicUp-kg?e=WZz1Ys'
        };

        // Default competencies (up to 6)
        const defaultCompetencies = [
            'Technical Skills',
            'Communication',
            'Teamwork & Collaboration',
            'Problem Solving',
            'Leadership',
            'Innovation & Creativity'
        ];

        // Initialize variables FIRST - before any functions that use them
        // Use var instead of let to avoid temporal dead zone issues
        var competencyCount = 0;
        var goalCount = 0;
        var managerRatingValue = 0;
        var currentAppraisalId = null;
        
        // Make sure variables are initialized immediately
        console.log('Variables initialized:', { competencyCount, goalCount });

        // Generate unique appraisal ID
        function generateAppraisalId() {
            // Format: APP-YYYYMMDD-HHMMSS-XXXX (last 4 random chars)
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeStr = hours + minutes + seconds;
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `APP-${dateStr}-${timeStr}-${random}`;
        }

        // Get appraisal ID from URL or generate new one
        function getAppraisalId() {
            const urlParams = new URLSearchParams(window.location.search);
            const idFromUrl = urlParams.get('id');
            
            if (idFromUrl) {
                return idFromUrl;
            }
            
            // Generate new ID if none exists
            const newId = generateAppraisalId();
            // Update URL without reload
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', newId);
            window.history.replaceState({}, '', newUrl);
            return newId;
        }

        // Define addCompetency function BEFORE DOMContentLoaded
        function addCompetency(name = '') {
            // Ensure competencyCount is a valid number
            if (typeof competencyCount !== 'number' || isNaN(competencyCount)) {
                console.warn('competencyCount was not a number, resetting to 0');
                competencyCount = 0;
            }
            
            console.log('=== addCompetency function called! ===', 'name:', name, 'Current count:', competencyCount, 'Type:', typeof competencyCount);
            
            if (competencyCount >= 6) {
                alert('Maximum of 6 core competencies allowed.');
                return;
            }

            // Wait for container to be available if DOM isn't ready yet
            let container = document.getElementById('competenciesContainer');
            if (!container) {
                console.log('Container not found yet, waiting for DOM...');
                // Wait a bit for DOM to be ready
                if (document.readyState === 'loading') {
                    alert('Please wait for the page to finish loading, then try again.');
                    return;
                }
                // Try one more time
                container = document.getElementById('competenciesContainer');
                if (!container) {
                    console.error('Competencies container not found!');
                    alert('Error: Competencies container not found. Please refresh the page.');
                    return;
                }
            }
            
            console.log('Container found, creating competency element...');
            
            const div = document.createElement('div');
            div.className = 'competency-item';
            div.id = `competency-${competencyCount}`;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <input type="text" class="input-style flex-1 mr-2" placeholder="Competency name" 
                           value="${name}" id="competency-name-${competencyCount}">
                    <button class="btn-secondary text-sm" onclick="removeCompetency(${competencyCount})">
                        <i data-lucide="trash-2" class="inline-block w-4 h-4"></i>
                    </button>
                </div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Self-Assessment Rating</label>
                <div class="rating-scale mb-3" id="competency-rating-scale-${competencyCount}">
                    <button type="button" class="rating-btn" data-rating="1" data-competency-index="${competencyCount}" onclick="if(typeof setCompetencyRating === 'function') { setCompetencyRating(${competencyCount}, 1); } else { console.error('setCompetencyRating not available'); }">1</button>
                    <button type="button" class="rating-btn" data-rating="2" data-competency-index="${competencyCount}" onclick="if(typeof setCompetencyRating === 'function') { setCompetencyRating(${competencyCount}, 2); } else { console.error('setCompetencyRating not available'); }">2</button>
                    <button type="button" class="rating-btn" data-rating="3" data-competency-index="${competencyCount}" onclick="if(typeof setCompetencyRating === 'function') { setCompetencyRating(${competencyCount}, 3); } else { console.error('setCompetencyRating not available'); }">3</button>
                    <button type="button" class="rating-btn" data-rating="4" data-competency-index="${competencyCount}" onclick="if(typeof setCompetencyRating === 'function') { setCompetencyRating(${competencyCount}, 4); } else { console.error('setCompetencyRating not available'); }">4</button>
                    <button type="button" class="rating-btn" data-rating="5" data-competency-index="${competencyCount}" onclick="if(typeof setCompetencyRating === 'function') { setCompetencyRating(${competencyCount}, 5); } else { console.error('setCompetencyRating not available'); }">5</button>
                </div>
                <input type="hidden" id="competency-rating-${competencyCount}" value="">
                <label class="block text-sm font-medium text-gray-700 mb-2">Self-Assessment Comments</label>
                <textarea class="input-style" id="competency-comments-${competencyCount}" 
                          placeholder="Provide specific examples and evidence..."></textarea>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('competency-comments-${competencyCount}', 'Provide self-assessment comments for this competency')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance
                </button>
                <div id="competency-comments-${competencyCount}-AI" class="ai-suggestion hidden"></div>
            `;
            
            container.appendChild(div);
            
            // Store the current index before incrementing
            const currentIndex = competencyCount;
            console.log('Competency element added to container. Index:', currentIndex, 'Display number:', currentIndex + 1);
            lucide.createIcons();
            
            // Increment AFTER creating the element
            competencyCount++;
            console.log('competencyCount incremented to:', competencyCount);
            
            // Verify the onclick handlers have the correct index (only log, don't modify)
            if (console && console.log) {
                const ratingButtons = div.querySelectorAll('.rating-btn');
                ratingButtons.forEach((btn, i) => {
                    const btnIndex = parseInt(btn.getAttribute('data-competency-index'));
                    if (btnIndex !== currentIndex) {
                        console.warn(`Rating button ${i + 1} index mismatch:`, btnIndex, 'Expected:', currentIndex);
                    }
                });
            }
            
            // Update add button state based on current count
            const btn = document.getElementById('addCompetencyBtn');
            if (btn) {
                if (competencyCount >= 6) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    console.log('Add Competency button disabled (max reached)');
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    console.log('Add Competency button enabled');
                }
            }
            
            console.log('Competency added successfully. Total count:', competencyCount);
        }

        // Define addGoal function BEFORE DOMContentLoaded
        function addGoal() {
            // Wait for container to be available if DOM isn't ready yet
            let container = document.getElementById('goalsContainer');
            if (!container) {
                console.log('Container not found yet, waiting for DOM...');
                // Wait a bit for DOM to be ready
                if (document.readyState === 'loading') {
                    alert('Please wait for the page to finish loading, then try again.');
                    return;
                }
                // Try one more time
                container = document.getElementById('goalsContainer');
                if (!container) {
                    console.error('Goals container not found!');
                    alert('Error: Goals container not found. Please refresh the page.');
                    return;
                }
            }
            
            // ALWAYS count existing goals to get the correct index for the new goal
            // Use a more specific selector - only match div elements with id="goal-X" (not goal-title-X, etc.)
            const existingGoals = container.querySelectorAll('div[id^="goal-"]');
            // Filter to only get the main goal containers (not nested elements)
            const actualGoalElements = Array.from(existingGoals).filter(el => {
                const id = el.id;
                // Match only IDs like "goal-0", "goal-1", etc. (not "goal-title-0")
                return /^goal-\d+$/.test(id);
            });
            const actualGoalCount = actualGoalElements.length;
            
            // Set goalCount to match actual count (this ensures it's always correct)
            goalCount = actualGoalCount;
            
            console.log('=== addGoal called === Existing goal containers:', actualGoalCount, 'New goal will be index:', goalCount);
            
            const div = document.createElement('div');
            div.className = 'card mb-4';
            div.id = `goal-${goalCount}`;
            
            // Calculate display number (goalCount is 0-based, display is 1-based)
            const goalDisplayNumber = goalCount + 1;
            console.log('Adding goal with index:', goalCount, 'Display number:', goalDisplayNumber);
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">Goal ${goalDisplayNumber}</h3>
                    <button class="btn-secondary text-sm" onclick="removeGoal(${goalCount})">
                        <i data-lucide="trash-2" class="inline-block w-4 h-4"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Goal Title</label>
                    <input type="text" class="input-style" placeholder="Enter goal title" id="goal-title-${goalCount}">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea class="input-style" placeholder="Describe the goal in detail..." id="goal-description-${goalCount}"></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Success Criteria</label>
                    <textarea class="input-style" placeholder="How will success be measured?" id="goal-success-${goalCount}"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target Date</label>
                        <input type="date" class="input-style" id="goal-date-${goalCount}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select class="input-style" id="goal-priority-${goalCount}">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <button class="btn-secondary mt-2 text-sm" onclick="getAIAssistance('goal-description-${goalCount}', 'Help me write a SMART goal description')">
                    <i data-lucide="sparkles" class="inline-block w-4 h-4 mr-2"></i>
                    Get AI Assistance for Goal
                </button>
                <div id="goal-description-${goalCount}-AI" class="ai-suggestion hidden"></div>
            `;
            
            container.appendChild(div);
            console.log('Goal element added to container. Display number:', goalDisplayNumber);
            lucide.createIcons();
            // goalCount is already correct (we set it based on actual count before adding)
            // No need to increment - next goal will count again and get the correct number
            console.log('Goal added successfully. Current goalCount:', goalCount);
        }

        // NOW create wrapper functions AFTER addCompetency and addGoal are defined
        // This ensures all variables and functions are initialized
        // Store reference to original function to avoid recursion
        const originalAddCompetency = addCompetency;
        window.addCompetency = function(name = '') {
            console.log('=== window.addCompetency CALLED ===', name);
            try {
                // Call the original function directly to avoid recursion
                originalAddCompetency(name);
            } catch(e) {
                console.error('Error in addCompetency:', e);
                alert('Error adding competency: ' + e.message);
            }
        };
        
        // Store reference to original function to avoid recursion
        const originalAddGoal = addGoal;
        window.addGoal = function() {
            console.log('=== window.addGoal CALLED ===');
            try {
                // Call the original function directly to avoid recursion
                originalAddGoal();
            } catch(e) {
                console.error('Error in addGoal:', e);
                alert('Error adding goal: ' + e.message);
            }
        };
        
        // Debug: Log function availability immediately
        console.log('Functions defined. Check:', {
            addCompetency: typeof addCompetency,
            addGoal: typeof addGoal,
            window_addCompetency: typeof window.addCompetency,
            window_addGoal: typeof window.addGoal,
            competencyCount: competencyCount,
            goalCount: goalCount
        });

        // Comprehensive AI Assessment Function - Define BEFORE DOMContentLoaded
        async function runComprehensiveAIAssessment() {
            console.log('Running comprehensive AI assessment...');
            
            // Show loading state
            const loadingDiv = document.getElementById('aiAssessmentLoading');
            const resultsDiv = document.getElementById('aiAssessmentResults');
            const contentDiv = document.getElementById('aiAssessmentContent');
            const rerunBtn = document.getElementById('rerunAIAssessmentBtn');
            
            if (loadingDiv) loadingDiv.classList.remove('hidden');
            if (resultsDiv) resultsDiv.classList.add('hidden');
            
            try {
                // Collect all appraisal data
                const appraisalData = collectAppraisalData();
                
                // Simulate API delay (replace with actual AI API call)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generate comprehensive assessment
                const assessment = generateComprehensiveAssessment(appraisalData);
                
                // Display results
                if (contentDiv) {
                    contentDiv.innerHTML = assessment;
                }
                
                if (resultsDiv) {
                    resultsDiv.classList.remove('hidden');
                }
                
                if (rerunBtn) {
                    rerunBtn.classList.remove('hidden');
                }
                
                // Scroll to results
                resultsDiv?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error('AI Assessment error:', error);
                if (contentDiv) {
                    contentDiv.innerHTML = '<div class="text-red-600 p-4">Error generating assessment. Please try again.</div>';
                }
                if (resultsDiv) {
                    resultsDiv.classList.remove('hidden');
                }
            } finally {
                if (loadingDiv) loadingDiv.classList.add('hidden');
                lucide.createIcons();
            }
        }
        
        // Make function globally accessible
        window.runComprehensiveAIAssessment = runComprehensiveAIAssessment;
        
        // Create wrapper functions AFTER all functions are defined
        // These wrappers will be called from onclick handlers
        // We need to wait until after addCompetency and addGoal are defined
        // So we'll define these wrappers at the end, after all functions are defined

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons first
            lucide.createIcons();
            
            // Get or create appraisal ID - ALWAYS ensure ID exists
            currentAppraisalId = getAppraisalId();
            document.getElementById('appraisalId').textContent = currentAppraisalId;
            
            // Log the appraisal ID for debugging
            console.log('Appraisal ID:', currentAppraisalId);
            
            // Make functions globally accessible immediately (already done above for addCompetency, addGoal, runComprehensiveAIAssessment, getAIAssistance)
            window.removeCompetency = removeCompetency;
            window.removeGoal = removeGoal;
            window.setCompetencyRating = setCompetencyRating;
            window.setManagerRating = setManagerRating;
            
            // Set up event delegation for competency rating buttons as a backup
            // Primary method is inline onclick handlers in the HTML
            const competenciesContainer = document.getElementById('competenciesContainer');
            if (competenciesContainer) {
                console.log('Setting up event delegation for competency rating buttons (backup)');
                competenciesContainer.addEventListener('click', handleCompetencyRatingClick);
            } else {
                console.error('Competencies container not found when setting up event delegation');
            }
            
            initializeCompetencies();
            initializeGoals();
            setReviewDate();
            
            // Load saved data if ID exists in URL or localStorage
            const loaded = loadAppraisalById(currentAppraisalId);
            if (!loaded) {
                // If no saved data, ensure ID is in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.get('id')) {
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', currentAppraisalId);
                    window.history.replaceState({}, '', newUrl);
                }
            }
            
            // Update last saved time
            updateLastSavedTime();
            
            // Verify buttons exist and functions are accessible
            console.log('Function check:', {
                addCompetency: typeof window.addCompetency,
                addGoal: typeof window.addGoal,
                addCompetencyDirect: typeof addCompetency,
                addGoalDirect: typeof addGoal
            });
            
            // Attach event listeners directly to buttons - SIMPLE AND DIRECT
            const addCompetencyBtn = document.getElementById('addCompetencyBtn');
            if (addCompetencyBtn) {
                console.log('Add Competency button found, attaching listener');
                addCompetencyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('=== Add Competency button clicked! ===');
                    window.addCompetency();
                });
            } else {
                console.error('Add Competency button not found!');
            }
            
            const addGoalBtn = document.getElementById('addGoalBtn');
            if (addGoalBtn) {
                console.log('Add Goal button found, attaching listener');
                addGoalBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('=== Add Goal button clicked! ===');
                    window.addGoal();
                });
            } else {
                console.error('Add Goal button not found!');
            }
            
            // Reinitialize icons after content is loaded
            setTimeout(() => {
                lucide.createIcons();
                saveToLocalStorage();
            }, 100);
        });

        function setReviewDate() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('reviewDate').value = dateStr;
        }

        // Event delegation handler for competency rating buttons
        function handleCompetencyRatingClick(e) {
            // Find the rating button (could be clicked directly or child element was clicked)
            const ratingBtn = e.target.closest('.rating-btn');
            if (ratingBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                // Find the rating scale container (parent of the button)
                const ratingScale = ratingBtn.closest('.rating-scale');
                if (ratingScale) {
                    // Extract the competency index from the rating scale ID
                    const ratingScaleId = ratingScale.id;
                    console.log('Clicked rating scale ID:', ratingScaleId);
                    const match = ratingScaleId.match(/competency-rating-scale-(\d+)/);
                    if (match) {
                        const competencyIndex = parseInt(match[1]);
                        const rating = parseInt(ratingBtn.getAttribute('data-rating'));
                        console.log('Event delegation: Rating button clicked for competency', competencyIndex, 'rating:', rating);
                        if (!isNaN(competencyIndex) && !isNaN(rating)) {
                            setCompetencyRating(competencyIndex, rating);
                        } else {
                            console.error('Invalid competency index or rating:', { competencyIndex, rating, ratingScaleId });
                        }
                    } else {
                        console.error('Could not extract competency index from rating scale ID:', ratingScaleId);
                        // Fallback: try to find parent competency element
                        const competencyEl = ratingBtn.closest('.competency-item');
                        if (competencyEl) {
                            const competencyId = competencyEl.id;
                            const idMatch = competencyId.match(/competency-(\d+)/);
                            if (idMatch) {
                                const competencyIndex = parseInt(idMatch[1]);
                                const rating = parseInt(ratingBtn.getAttribute('data-rating'));
                                console.log('Fallback: Using competency element ID, competency', competencyIndex, 'rating:', rating);
                                if (!isNaN(competencyIndex) && !isNaN(rating)) {
                                    setCompetencyRating(competencyIndex, rating);
                                }
                            }
                        }
                    }
                } else {
                    console.error('Could not find rating scale container for clicked button');
                }
            }
        }

        function initializeCompetencies() {
            const container = document.getElementById('competenciesContainer');
            if (!container) {
                console.error('Competencies container not found');
                return;
            }
            container.innerHTML = '';
            competencyCount = 0;
            
            // Add default competencies - use original function directly to avoid recursion
            const originalAddCompetency = addCompetency;
            defaultCompetencies.forEach(competency => {
                if (competencyCount < 6) {
                    originalAddCompetency(competency);
                }
            });
        }

        function removeCompetency(index) {
            console.log('=== removeCompetency called === index:', index, 'current competencyCount:', competencyCount);
            const element = document.getElementById(`competency-${index}`);
            if (element) {
                element.remove();
                console.log('Competency element removed');
                
                // Renumber all remaining competencies sequentially (like we do for goals)
                const container = document.getElementById('competenciesContainer');
                if (container) {
                    // Get all remaining competencies - only match main competency containers
                    const allCompetencies = Array.from(container.querySelectorAll('div[id^="competency-"]'));
                    const remainingCompetencies = allCompetencies.filter(el => {
                        const id = el.id;
                        // Match only IDs like "competency-0", "competency-1", etc.
                        return /^competency-\d+$/.test(id);
                    });
                    console.log('Remaining competencies after deletion:', remainingCompetencies.length, 'current competencyCount was:', competencyCount);
                    
                    // IMPORTANT: Set competencyCount to the number of remaining competencies IMMEDIATELY
                    const newCompetencyCount = remainingCompetencies.length;
                    competencyCount = newCompetencyCount;
                    console.log('=== Set competencyCount to:', competencyCount, 'based on remaining competencies count ===');
                    
                    // Renumber remaining competencies sequentially
                    remainingCompetencies.forEach((compEl, newIndex) => {
                        const oldId = compEl.id;
                        const newId = `competency-${newIndex}`;
                        const displayNumber = newIndex + 1;
                        
                        console.log(`Renumbering competency: ${oldId} -> ${newId}`);
                        
                        compEl.id = newId;
                        
                        // Update all input IDs within this competency
                        const inputs = compEl.querySelectorAll('input, textarea, select, div[id*="competency-"]');
                        inputs.forEach(input => {
                            if (input.id) {
                                const oldInputId = input.id;
                                input.id = input.id.replace(/competency-\d+/, `competency-${newIndex}`);
                                console.log(`Updated input ID: ${oldInputId} -> ${input.id}`);
                            }
                        });
                        
                        // Update AI divs
                        const aiDivs = compEl.querySelectorAll('[id$="-AI"]');
                        aiDivs.forEach(div => {
                            if (div.id) {
                                div.id = div.id.replace(/competency-\d+/, `competency-${newIndex}`);
                            }
                        });
                        
                        // Update onclick handlers in buttons
                        const buttons = compEl.querySelectorAll('button[onclick]');
                        buttons.forEach(button => {
                            if (button.onclick || button.getAttribute('onclick')) {
                                const onclickAttr = button.getAttribute('onclick') || '';
                                const updatedOnclick = onclickAttr.replace(/competency-\d+/g, `competency-${newIndex}`);
                                button.setAttribute('onclick', updatedOnclick);
                            }
                        });
                    });
                    
                    console.log('Competency removed. Renumbered competencies. Final competencyCount:', competencyCount);
                }
                
                // Update button state - always re-enable after deletion
                const btn = document.getElementById('addCompetencyBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    console.log('Add Competency button re-enabled');
                }
            } else {
                console.error('Competency element not found for index:', index);
            }
        }

        function setCompetencyRating(index, rating) {
            console.log('=== setCompetencyRating called ===', { index, rating });
            
            // Validate inputs
            if (typeof index !== 'number' || isNaN(index) || index < 0) {
                console.error('Invalid competency index:', index);
                return;
            }
            if (typeof rating !== 'number' || isNaN(rating) || rating < 1 || rating > 5) {
                console.error('Invalid rating:', rating);
                return;
            }
            
            // Find the specific competency container
            const competencyEl = document.getElementById(`competency-${index}`);
            if (!competencyEl) {
                console.error('Competency element not found:', `competency-${index}`);
                return;
            }
            
            // Find the rating scale container for this specific competency
            const ratingScale = document.getElementById(`competency-rating-scale-${index}`);
            if (!ratingScale) {
                console.error('Rating scale not found:', `competency-rating-scale-${index}`);
                // Fallback: try to find it within the competency element
                const fallbackScale = competencyEl.querySelector('.rating-scale');
                if (fallbackScale) {
                    console.log('Found fallback rating scale');
                    const buttons = fallbackScale.querySelectorAll('.rating-btn');
                    buttons.forEach((btn, i) => {
                        const btnRating = parseInt(btn.getAttribute('data-rating')) || (i + 1);
                        if (btnRating === rating) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                } else {
                    console.error('Could not find rating scale for competency', index);
                    return;
                }
            } else {
                // Get rating buttons ONLY within this specific rating scale
                const buttons = ratingScale.querySelectorAll('.rating-btn');
                console.log('Found buttons:', buttons.length, 'for competency', index, 'in rating scale', `competency-rating-scale-${index}`);
                
                buttons.forEach((btn) => {
                    const btnRating = parseInt(btn.getAttribute('data-rating'));
                    if (!isNaN(btnRating) && btnRating === rating) {
                        btn.classList.add('active');
                        console.log('Activated button', btnRating, 'for competency', index);
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            
            const hiddenInput = document.getElementById(`competency-rating-${index}`);
            if (hiddenInput) {
                hiddenInput.value = rating;
                console.log('Set rating value to', rating, 'for competency', index);
            } else {
                console.error('Rating input not found:', `competency-rating-${index}`);
            }
        }

        function initializeGoals() {
            const container = document.getElementById('goalsContainer');
            if (!container) {
                console.error('Goals container not found');
                return;
            }
            container.innerHTML = '';
            // Ensure goalCount is a valid number
            goalCount = 0;
            
            // Add one default goal - use original function directly to avoid recursion
            // We need to call the original addGoal, not window.addGoal
            // Since this is defined before window.addGoal is assigned, we can call it directly
            const originalAddGoal = addGoal;
            originalAddGoal();
        }

        function removeGoal(index) {
            console.log('=== removeGoal called === index:', index, 'current goalCount:', goalCount);
            const element = document.getElementById(`goal-${index}`);
            if (element) {
                element.remove();
                console.log('Goal element removed');
                
                // Renumber all remaining goals sequentially
                const container = document.getElementById('goalsContainer');
                if (container) {
                    // Get all remaining goals - only match main goal containers, not nested elements
                    const allGoals = Array.from(container.querySelectorAll('div[id^="goal-"]'));
                    const remainingGoals = allGoals.filter(el => {
                        const id = el.id;
                        // Match only IDs like "goal-0", "goal-1", etc. (not "goal-title-0")
                        return /^goal-\d+$/.test(id);
                    });
                    console.log('Remaining goals after deletion:', remainingGoals.length, 'current goalCount was:', goalCount);
                    
                    // IMPORTANT: Set goalCount to the number of remaining goals IMMEDIATELY
                    // This ensures the next goal added will be numbered correctly
                    const newGoalCount = remainingGoals.length;
                    goalCount = newGoalCount;
                    console.log('=== Set goalCount to:', goalCount, 'based on remaining goals count ===');
                    console.log('Next goal added will have ID: goal-', goalCount, 'and display: Goal', goalCount + 1);
                    
                    // Renumber all goals sequentially starting from 0
                    remainingGoals.forEach((goalEl, newIndex) => {
                        const oldId = goalEl.id;
                        const newId = `goal-${newIndex}`;
                        const displayNumber = newIndex + 1;
                        
                        console.log(`Renumbering goal: ${oldId} -> ${newId}, display: Goal ${displayNumber}`);
                        
                        // Update the goal element ID
                        goalEl.id = newId;
                        
                        // Update all input/textarea IDs within this goal
                        const inputs = goalEl.querySelectorAll('input, textarea, select');
                        inputs.forEach(input => {
                            if (input.id) {
                                const oldInputId = input.id;
                                input.id = input.id.replace(/goal-\d+/, `goal-${newIndex}`);
                                console.log(`Updated input ID: ${oldInputId} -> ${input.id}`);
                            }
                        });
                        
                        // Update AI assistance div IDs
                        const aiDivs = goalEl.querySelectorAll('[id$="-AI"]');
                        aiDivs.forEach(div => {
                            if (div.id) {
                                div.id = div.id.replace(/goal-\d+/, `goal-${newIndex}`);
                            }
                        });
                        
                        // Update onclick handlers
                        const buttons = goalEl.querySelectorAll('button[onclick]');
                        buttons.forEach(button => {
                            if (button.onclick || button.getAttribute('onclick')) {
                                const onclickAttr = button.getAttribute('onclick') || '';
                                const updatedOnclick = onclickAttr.replace(/goal-\d+/g, `goal-${newIndex}`);
                                button.setAttribute('onclick', updatedOnclick);
                            }
                        });
                        
                        // Update display number
                        const titleEl = goalEl.querySelector('h3');
                        if (titleEl) {
                            titleEl.textContent = `Goal ${displayNumber}`;
                        }
                        
                        // Update removeGoal onclick handler
                        const removeBtn = goalEl.querySelector('button[onclick*="removeGoal"]');
                        if (removeBtn) {
                            removeBtn.setAttribute('onclick', `removeGoal(${newIndex})`);
                        }
                    });
                    
                    console.log('Goal removed. Renumbered goals. Final goalCount:', goalCount);
                }
            } else {
                console.error('Goal element not found for index:', index);
            }
        }

        function setManagerRating(rating) {
            console.log('Setting manager rating:', rating);
            const ratingScale = document.getElementById('managerRatingScale');
            if (!ratingScale) {
                console.error('Manager rating scale not found');
                return;
            }
            
            const buttons = ratingScale.querySelectorAll('.rating-btn');
            buttons.forEach((btn, i) => {
                if (i + 1 === rating) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            managerRatingValue = rating;
            const hiddenInput = document.getElementById('managerRating');
            if (hiddenInput) {
                hiddenInput.value = rating;
            }
            
            console.log('Manager rating set to:', rating);
        }

        // AI Assistance Function for individual fields
        async function getAIAssistance(fieldId, context) {
            console.log('AI Assistance requested for:', fieldId, context);
            const field = document.getElementById(fieldId);
            const aiDiv = document.getElementById(`${fieldId}-AI`);
            
            if (!field) {
                console.error('Field not found:', fieldId);
                return;
            }
            
            if (!aiDiv) {
                console.error('AI div not found:', `${fieldId}-AI`);
                return;
            }

            // Show loading
            aiDiv.classList.remove('hidden');
            aiDiv.innerHTML = '<div class="loading"></div> <span class="ml-2">Generating AI suggestions...</span>';
            lucide.createIcons();

            try {
                // For demo purposes, we'll use a mock AI response
                // In production, you would call Azure OpenAI (GPT-4o/GPT-4 Turbo), OpenAI API, or similar
                // Note: Update to GPT-5.0 when available
                const response = await mockAIResponse(fieldId, context, field.value);
                
                aiDiv.innerHTML = `
                    <div class="mb-2">
                        <strong>AI Suggestion:</strong>
                        <p class="mt-2">${response}</p>
                    </div>
                    <button class="btn-secondary text-sm mt-2" onclick="useAISuggestion('${fieldId}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                        Use This Suggestion
                    </button>
                    <button class="btn-secondary text-sm mt-2 ml-2" onclick="document.getElementById('${fieldId}-AI').classList.add('hidden')">
                        Dismiss
                    </button>
                `;
            } catch (error) {
                aiDiv.innerHTML = `
                    <div class="text-red-600">
                        <p>Error generating AI suggestion. Please try again.</p>
                        <button class="btn-secondary text-sm mt-2" onclick="document.getElementById('${fieldId}-AI').classList.add('hidden')">
                            Dismiss
                        </button>
                    </div>
                `;
                console.error('AI assistance error:', error);
            }
        }

        // Mock AI Response (Replace with actual AI API call)
        async function mockAIResponse(fieldId, context, currentValue) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Mock responses based on field type
            const mockResponses = {
                'keyAchievements': 'Based on your input, here are some suggested achievements to highlight:\n\nâ€¢ Successfully completed [project/task] ahead of schedule\nâ€¢ Demonstrated strong [skill] by [specific example]\nâ€¢ Contributed to team success by [specific action]\nâ€¢ Received positive feedback from [stakeholder/team]\n\nRemember to be specific and quantify your achievements where possible.',
                'challengesLearnings': 'Reflecting on challenges and learnings, consider:\n\nâ€¢ Technical challenges: [specific challenge] and how you overcame it\nâ€¢ Process improvements: What you learned about [specific process]\nâ€¢ Skill development: New skills you acquired or improved\nâ€¢ Collaboration insights: What you learned about working with others',
                'areasForImprovement': 'Areas for improvement to consider:\n\nâ€¢ Technical skills: [specific skill] that could be enhanced\nâ€¢ Communication: Ways to improve [specific communication aspect]\nâ€¢ Time management: Strategies for better prioritization\nâ€¢ Leadership: Opportunities to develop leadership capabilities',
                'competency': 'For this competency, consider:\n\nâ€¢ Specific examples of when you demonstrated this competency\nâ€¢ Quantifiable results or impact\nâ€¢ Feedback received from colleagues or stakeholders\nâ€¢ Continuous improvement in this area',
                'managerCompetencyFeedback': 'For competency feedback, consider:\n\nâ€¢ Compare your assessment with the employee\'s self-assessment\nâ€¢ Provide specific examples of observed behaviors\nâ€¢ Acknowledge strengths and address gaps\nâ€¢ Be constructive and supportive\nâ€¢ Include actionable steps for improvement',
                'managerStrengths': 'For identifying strengths, consider:\n\nâ€¢ Technical skills: [specific skill] demonstrated through [example]\nâ€¢ Soft skills: [specific skill] shown in [situation]\nâ€¢ Business impact: How strengths contributed to [outcome]\nâ€¢ Be specific with examples and connect to business value',
                'managerDevelopmentAreas': 'For development areas, consider:\n\nâ€¢ Identify 2-3 key areas for growth\nâ€¢ Be constructive and frame as opportunities\nâ€¢ Provide specific examples of where improvement is needed\nâ€¢ Suggest actionable steps for development\nâ€¢ Ensure recommendations are achievable',
                'managerRecommendations': 'For recommendations, consider:\n\nâ€¢ Align with employee\'s goals where appropriate\nâ€¢ Suggest specific development activities (training, projects, mentorship)\nâ€¢ Set clear expectations for improvement\nâ€¢ Make recommendations actionable and measurable\nâ€¢ Include timeline or checkpoints'
            };

            // Determine response type
            let responseType = 'competency';
            if (fieldId.includes('keyAchievements')) responseType = 'keyAchievements';
            else if (fieldId.includes('challengesLearnings')) responseType = 'challengesLearnings';
            else if (fieldId.includes('areasForImprovement')) responseType = 'areasForImprovement';
            else if (fieldId.includes('competency-comments')) responseType = 'competency';
            else if (fieldId.includes('managerCompetencyFeedback')) responseType = 'managerCompetencyFeedback';
            else if (fieldId.includes('managerStrengths')) responseType = 'managerStrengths';
            else if (fieldId.includes('managerDevelopmentAreas')) responseType = 'managerDevelopmentAreas';
            else if (fieldId.includes('managerRecommendations')) responseType = 'managerRecommendations';
            else if (fieldId.includes('goal')) {
                return 'Here\'s a SMART goal framework:\n\nâ€¢ Specific: Clearly define what you want to achieve\nâ€¢ Measurable: Include metrics to track progress\nâ€¢ Achievable: Ensure the goal is realistic\nâ€¢ Relevant: Align with team/company objectives\nâ€¢ Time-bound: Set a clear deadline\n\nExample: "By [date], I will [specific action] resulting in [measurable outcome]."';
            }

            return mockResponses[responseType] || mockResponses['competency'];
        }

        function useAISuggestion(fieldId, suggestion) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = suggestion;
                document.getElementById(`${fieldId}-AI`).classList.add('hidden');
            }
        }
        
        // Make AI assistance functions globally accessible
        window.getAIAssistance = getAIAssistance;
        window.useAISuggestion = useAISuggestion;

        // Generate comprehensive assessment based on appraisal data
        function generateComprehensiveAssessment(data) {
            let assessment = '';
            
            // Employee Section Assessment
            assessment += '<div class="border-b border-gray-200 pb-4 mb-4">';
            assessment += '<h4 class="text-lg font-semibold text-blue-800 mb-3 flex items-center gap-2">';
            assessment += '<i data-lucide="user" class="w-5 h-5"></i>';
            assessment += 'Employee Section Assessment';
            assessment += '</h4>';
            
            // Check competencies
            if (!data.selfAssessment || !data.selfAssessment.competencies || data.selfAssessment.competencies.length === 0) {
                assessment += '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">';
                assessment += '<p class="text-yellow-800"><strong>âš ï¸ Missing:</strong> No competencies have been added. Consider adding at least 3-4 core competencies with ratings and detailed comments.</p>';
                assessment += '</div>';
            } else {
                assessment += '<div class="bg-green-50 border-l-4 border-green-400 p-3 mb-3">';
                assessment += `<p class="text-green-800"><strong>âœ“ Completed:</strong> ${data.selfAssessment.competencies.length} competency/competencies added.</p>`;
                assessment += '</div>';
                
                // Review each competency
                data.selfAssessment.competencies.forEach((comp, idx) => {
                    assessment += '<div class="ml-4 mb-2 p-2 bg-gray-50 rounded">';
                    assessment += `<p class="font-medium">Competency ${idx + 1}: ${comp.name || 'Unnamed'}</p>`;
                    if (!comp.rating || comp.rating === '') {
                        assessment += '<p class="text-yellow-700 text-sm">âš ï¸ Rating not provided</p>';
                    }
                    if (!comp.comments || comp.comments.trim() === '') {
                        assessment += '<p class="text-yellow-700 text-sm">âš ï¸ Comments missing - add specific examples and evidence</p>';
                    } else if (comp.comments.length < 50) {
                        assessment += '<p class="text-yellow-700 text-sm">ðŸ’¡ Suggestion: Expand comments with more specific examples and quantifiable results</p>';
                    } else {
                        assessment += '<p class="text-green-700 text-sm">âœ“ Comments are detailed</p>';
                    }
                    assessment += '</div>';
                });
            }
            
            // Check self-reflection
            const hasReflection = data.selfReflection && (
                (data.selfReflection.keyAchievements && data.selfReflection.keyAchievements.trim() !== '') ||
                (data.selfReflection.challengesLearnings && data.selfReflection.challengesLearnings.trim() !== '') ||
                (data.selfReflection.areasForImprovement && data.selfReflection.areasForImprovement.trim() !== '')
            );
            
            if (!hasReflection) {
                assessment += '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">';
                assessment += '<p class="text-yellow-800"><strong>âš ï¸ Missing:</strong> Self-reflection section is incomplete. Add key achievements, challenges/learnings, and areas for improvement.</p>';
                assessment += '</div>';
            } else {
                assessment += '<div class="bg-green-50 border-l-4 border-green-400 p-3 mb-3">';
                assessment += '<p class="text-green-800"><strong>âœ“ Completed:</strong> Self-reflection section has content.</p>';
                assessment += '</div>';
                
                if (data.selfReflection.keyAchievements && data.selfReflection.keyAchievements.trim() !== '') {
                    if (data.selfReflection.keyAchievements.length < 100) {
                        assessment += '<p class="ml-4 text-yellow-700 text-sm mb-2">ðŸ’¡ Key Achievements: Consider adding more specific examples with metrics and impact</p>';
                    }
                }
            }
            
            // Check goals
            if (!data.goals || data.goals.length === 0) {
                assessment += '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">';
                assessment += '<p class="text-yellow-800"><strong>âš ï¸ Missing:</strong> No goals have been set for the next 6 months. Add at least 2-3 SMART goals.</p>';
                assessment += '</div>';
            } else {
                assessment += '<div class="bg-green-50 border-l-4 border-green-400 p-3 mb-3">';
                assessment += `<p class="text-green-800"><strong>âœ“ Completed:</strong> ${data.goals.length} goal/goals added.</p>`;
                assessment += '</div>';
                
                data.goals.forEach((goal, idx) => {
                    assessment += '<div class="ml-4 mb-2 p-2 bg-gray-50 rounded">';
                    assessment += `<p class="font-medium">Goal ${idx + 1}: ${goal.title || 'Untitled'}</p>`;
                    if (!goal.description || goal.description.trim() === '') {
                        assessment += '<p class="text-yellow-700 text-sm">âš ï¸ Description missing - make it SMART (Specific, Measurable, Achievable, Relevant, Time-bound)</p>';
                    }
                    if (!goal.successCriteria || goal.successCriteria.trim() === '') {
                        assessment += '<p class="text-yellow-700 text-sm">âš ï¸ Success criteria missing - define how you\'ll measure completion</p>';
                    }
                    if (!goal.targetDate) {
                        assessment += '<p class="text-yellow-700 text-sm">âš ï¸ Target date not set</p>';
                    }
                    assessment += '</div>';
                });
            }
            
            assessment += '</div>';
            
            // Manager Section Assessment
            assessment += '<div class="border-b border-gray-200 pb-4 mb-4">';
            assessment += '<h4 class="text-lg font-semibold text-blue-800 mb-3 flex items-center gap-2">';
            assessment += '<i data-lucide="user-check" class="w-5 h-5"></i>';
            assessment += 'Manager Section Assessment';
            assessment += '</h4>';
            
            if (!data.managerAssessment) {
                assessment += '<div class="bg-gray-50 border-l-4 border-gray-400 p-3 mb-3">';
                assessment += '<p class="text-gray-800"><strong>â„¹ï¸ Pending:</strong> Manager assessment has not been completed yet.</p>';
                assessment += '</div>';
            } else {
                if (!data.managerAssessment.rating || data.managerAssessment.rating === '') {
                    assessment += '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">';
                    assessment += '<p class="text-yellow-800"><strong>âš ï¸ Missing:</strong> Overall performance rating not provided.</p>';
                    assessment += '</div>';
                } else {
                    assessment += '<div class="bg-green-50 border-l-4 border-green-400 p-3 mb-3">';
                    assessment += `<p class="text-green-800"><strong>âœ“ Completed:</strong> Overall rating: ${data.managerAssessment.rating}/5</p>`;
                    assessment += '</div>';
                }
                
                if (!data.managerAssessment.competencyFeedback || data.managerAssessment.competencyFeedback.trim() === '') {
                    assessment += '<p class="ml-4 text-yellow-700 text-sm mb-2">âš ï¸ Competency feedback missing - provide specific feedback on each competency</p>';
                }
                
                if (!data.managerAssessment.strengths || data.managerAssessment.strengths.trim() === '') {
                    assessment += '<p class="ml-4 text-yellow-700 text-sm mb-2">âš ï¸ Strengths section empty - identify 3-5 key strengths with examples</p>';
                } else if (data.managerAssessment.strengths.length < 100) {
                    assessment += '<p class="ml-4 text-yellow-700 text-sm mb-2">ðŸ’¡ Strengths: Consider adding more specific examples and connecting to business impact</p>';
                }
                
                if (!data.managerAssessment.developmentAreas || data.managerAssessment.developmentAreas.trim() === '') {
                    assessment += '<p class="ml-4 text-yellow-700 text-sm mb-2">âš ï¸ Development areas missing - identify 2-3 areas for growth with actionable steps</p>';
                }
                
                if (!data.managerAssessment.recommendations || data.managerAssessment.recommendations.trim() === '') {
                    assessment += '<p class="ml-4 text-yellow-700 text-sm mb-2">âš ï¸ Recommendations missing - provide specific development activities for next 6 months</p>';
                }
            }
            
            assessment += '</div>';
            
            // Overall Recommendations
            assessment += '<div class="bg-blue-50 border-l-4 border-blue-400 p-4">';
            assessment += '<h4 class="text-lg font-semibold text-blue-800 mb-3 flex items-center gap-2">';
            assessment += '<i data-lucide="lightbulb" class="w-5 h-5"></i>';
            assessment += 'Overall Recommendations';
            assessment += '</h4>';
            assessment += '<ul class="list-disc list-inside space-y-2 text-gray-700">';
            assessment += '<li>Be specific with examples and use quantifiable metrics where possible</li>';
            assessment += '<li>Ensure all sections are complete before finalizing</li>';
            assessment += '<li>Align employee goals with manager recommendations</li>';
            assessment += '<li>Use action verbs and clear language throughout</li>';
            assessment += '<li>Review your responses and make improvements based on this feedback</li>';
            assessment += '<li><strong>Tip:</strong> You can rerun this assessment after making improvements to see updated feedback</li>';
            assessment += '</ul>';
            assessment += '</div>';
            
            return assessment;
        }

        // Save Draft (saves to browser and optionally downloads)
        function saveDraft() {
            try {
                // Ensure Appraisal ID exists before saving
                if (!currentAppraisalId) {
                    currentAppraisalId = getAppraisalId();
                    document.getElementById('appraisalId').textContent = currentAppraisalId;
                }
                
                // Save to localStorage (auto-save already does this, but this is explicit)
                saveToLocalStorage();
                
                // Get all form data
                const appraisalData = collectAppraisalData();
                appraisalData.appraisalId = currentAppraisalId;
                appraisalData.status = 'draft'; // Mark as draft
                appraisalData.lastSaved = new Date().toISOString();
                
                // Convert to JSON
                const jsonData = JSON.stringify(appraisalData, null, 2);
                
                // Create filename with Draft indicator
                const employeeName = document.getElementById('employeeName').value || 'Employee';
                const reviewPeriod = document.getElementById('reviewPeriod').value || 'Review';
                const filename = `Performance_Appraisal_DRAFT_${currentAppraisalId}_${employeeName.replace(/\s+/g, '_')}_${reviewPeriod.replace(/\s+/g, '_')}.json`;
                
                // Download as backup
                downloadFile(jsonData, filename, 'application/json');
                
                showSaveStatus('Draft saved successfully! (Downloaded as backup)', 'green');
                
                // Update last saved time
                updateLastSavedTime();
            } catch (error) {
                console.error('Draft save error:', error);
                showSaveStatus('Error saving draft. Please try again.', 'red');
            }
        }

        // Save to SharePoint (works for both drafts and completed forms)
        async function saveToSharePoint() {
            try {
                // Ensure Appraisal ID exists before saving
                if (!currentAppraisalId) {
                    currentAppraisalId = getAppraisalId();
                    document.getElementById('appraisalId').textContent = currentAppraisalId;
                }
                
                // Show saving status
                showSaveStatus('Saving to SharePoint...', 'blue');

                // Get all form data (includes appraisalId) - works for incomplete forms too
                const appraisalData = collectAppraisalData();
                
                // Ensure appraisal ID is in the data
                appraisalData.appraisalId = currentAppraisalId;
                
                // Check if form is complete or draft
                const isComplete = checkFormCompletion(appraisalData);
                if (!isComplete) {
                    appraisalData.status = 'draft';
                } else {
                    appraisalData.status = 'completed';
                }

                // Convert to JSON
                const jsonData = JSON.stringify(appraisalData, null, 2);
                
                // Create filename with Appraisal ID for easy identification
                const employeeName = document.getElementById('employeeName').value || 'Employee';
                const reviewPeriod = document.getElementById('reviewPeriod').value || 'Review';
                const statusPrefix = isComplete ? '' : 'DRAFT_';
                const filename = `Performance_Appraisal_${statusPrefix}${currentAppraisalId}_${employeeName.replace(/\s+/g, '_')}_${reviewPeriod.replace(/\s+/g, '_')}.json`;
                
                // Also save as PDF-ready format
                const pdfData = generatePDFData(appraisalData);

                // Try to save to SharePoint
                try {
                    await saveToSharePointAPI(jsonData, filename);
                    const statusMsg = isComplete ? 'Saved to SharePoint successfully!' : 'Draft saved to SharePoint successfully!';
                    showSaveStatus(statusMsg, 'green');
                    
                    // Also save to localStorage as backup
                    saveToLocalStorage();
                } catch (sharePointError) {
                    console.error('SharePoint save error:', sharePointError);
                    
                    // Fallback: Save to localStorage and offer download
                    saveToLocalStorage();
                    downloadFile(jsonData, filename, 'application/json');
                    const fallbackMsg = isComplete 
                        ? 'Saved locally (SharePoint unavailable). File downloaded.' 
                        : 'Draft saved locally (SharePoint unavailable). File downloaded.';
                    showSaveStatus(fallbackMsg, 'orange');
                }
            } catch (error) {
                console.error('Save error:', error);
                showSaveStatus('Error saving. Please try again.', 'red');
            }
        }
        
        // Check if form is complete (optional - for status tracking)
        function checkFormCompletion(data) {
            // Check if employee sections are filled
            const employeeComplete = data.employeeInfo.name && 
                                   data.selfReflection.keyAchievements &&
                                   data.competencies.length > 0;
            
            // Check if manager sections are filled
            const managerComplete = data.managerAssessment.signature &&
                                   data.managerAssessment.rating;
            
            // Check if employee acknowledged
            const acknowledged = data.employeeAcknowledgment.acknowledged;
            
            // Form is complete if employee and manager sections are done and acknowledged
            return employeeComplete && managerComplete && acknowledged;
        }

        // Collect all appraisal data
        function collectAppraisalData() {
            const data = {
                appraisalId: currentAppraisalId || getAppraisalId(),
                employeeInfo: {
                    name: document.getElementById('employeeName').value,
                    id: document.getElementById('employeeId').value,
                    department: document.getElementById('department').value,
                    managerName: document.getElementById('managerName').value,
                    reviewPeriod: document.getElementById('reviewPeriod').value,
                    reviewDate: document.getElementById('reviewDate').value
                },
                competencies: [],
                selfReflection: {
                    keyAchievements: document.getElementById('keyAchievements').value,
                    challengesLearnings: document.getElementById('challengesLearnings').value,
                    areasForImprovement: document.getElementById('areasForImprovement').value
                },
                goals: [],
                managerAssessment: {
                    rating: document.getElementById('managerRating').value,
                    competencyFeedback: document.getElementById('managerCompetencyFeedback').value,
                    strengths: document.getElementById('managerStrengths').value,
                    developmentAreas: document.getElementById('managerDevelopmentAreas').value,
                    recommendations: document.getElementById('managerRecommendations').value,
                    signature: document.getElementById('managerSignature').value,
                    signatureDate: document.getElementById('managerSignatureDate').value
                },
                employeeAcknowledgment: {
                    acknowledged: document.getElementById('employeeAcknowledgment').checked,
                    signature: document.getElementById('employeeSignature').value,
                    signatureDate: document.getElementById('employeeSignatureDate').value
                },
                savedDate: new Date().toISOString()
            };

            // Collect competencies
            for (let i = 0; i < competencyCount; i++) {
                const competencyElement = document.getElementById(`competency-${i}`);
                if (competencyElement) {
                    data.competencies.push({
                        name: document.getElementById(`competency-name-${i}`).value,
                        rating: document.getElementById(`competency-rating-${i}`).value,
                        comments: document.getElementById(`competency-comments-${i}`).value
                    });
                }
            }

            // Collect goals
            for (let i = 0; i < goalCount; i++) {
                const goalElement = document.getElementById(`goal-${i}`);
                if (goalElement) {
                    data.goals.push({
                        title: document.getElementById(`goal-title-${i}`).value,
                        description: document.getElementById(`goal-description-${i}`).value,
                        successCriteria: document.getElementById(`goal-success-${i}`).value,
                        targetDate: document.getElementById(`goal-date-${i}`).value,
                        priority: document.getElementById(`goal-priority-${i}`).value
                    });
                }
            }

            return data;
        }

        // Generate PDF-ready data
        function generatePDFData(data) {
            // This would be used to generate a PDF version
            // For now, we'll return formatted text
            let pdfText = `PERFORMANCE APPRAISAL REPORT\n`;
            pdfText += `================================\n\n`;
            pdfText += `Appraisal ID: ${data.appraisalId || currentAppraisalId || 'Not Assigned'}\n`;
            pdfText += `Employee: ${data.employeeInfo.name}\n`;
            pdfText += `Employee ID: ${data.employeeInfo.id}\n`;
            pdfText += `Department: ${data.employeeInfo.department}\n`;
            pdfText += `Manager: ${data.employeeInfo.managerName}\n`;
            pdfText += `Review Period: ${data.employeeInfo.reviewPeriod}\n`;
            pdfText += `Review Date: ${data.employeeInfo.reviewDate}\n`;
            pdfText += `Saved Date: ${data.savedDate || new Date().toISOString()}\n\n`;
            
            pdfText += `CORE COMPETENCIES\n`;
            pdfText += `=================\n`;
            data.competencies.forEach((comp, idx) => {
                pdfText += `${idx + 1}. ${comp.name}\n`;
                pdfText += `   Rating: ${comp.rating}/5\n`;
                pdfText += `   Comments: ${comp.comments}\n\n`;
            });
            
            pdfText += `SELF-REFLECTION\n`;
            pdfText += `===============\n`;
            pdfText += `Key Achievements:\n${data.selfReflection.keyAchievements}\n\n`;
            pdfText += `Challenges and Learnings:\n${data.selfReflection.challengesLearnings}\n\n`;
            pdfText += `Areas for Improvement:\n${data.selfReflection.areasForImprovement}\n\n`;
            
            pdfText += `PERFORMANCE GOALS (Next 6 Months)\n`;
            pdfText += `==================================\n`;
            data.goals.forEach((goal, idx) => {
                pdfText += `${idx + 1}. ${goal.title}\n`;
                pdfText += `   Description: ${goal.description}\n`;
                pdfText += `   Success Criteria: ${goal.successCriteria}\n`;
                pdfText += `   Target Date: ${goal.targetDate}\n`;
                pdfText += `   Priority: ${goal.priority}\n\n`;
            });
            
            pdfText += `MANAGER ASSESSMENT\n`;
            pdfText += `==================\n`;
            pdfText += `Overall Rating: ${data.managerAssessment.rating}/5\n`;
            pdfText += `Competency Feedback:\n${data.managerAssessment.competencyFeedback}\n\n`;
            pdfText += `Strengths:\n${data.managerAssessment.strengths}\n\n`;
            pdfText += `Development Areas:\n${data.managerAssessment.developmentAreas}\n\n`;
            pdfText += `Recommendations:\n${data.managerAssessment.recommendations}\n\n`;
            pdfText += `Manager Signature: ${data.managerAssessment.signature}\n`;
            pdfText += `Date: ${data.managerAssessment.signatureDate}\n\n`;
            
            pdfText += `EMPLOYEE ACKNOWLEDGMENT\n`;
            pdfText += `=======================\n`;
            pdfText += `Acknowledged: ${data.employeeAcknowledgment.acknowledged ? 'Yes' : 'No'}\n`;
            pdfText += `Employee Signature: ${data.employeeAcknowledgment.signature}\n`;
            pdfText += `Date: ${data.employeeAcknowledgment.signatureDate}\n`;
            
            return pdfText;
        }

        // Export for SOC 2 Audit - Generate comprehensive document
        function exportForSOC2Audit() {
            console.log('Exporting appraisal for SOC 2 audit...');
            
            const data = collectAppraisalData();
            const exportDate = new Date().toISOString();
            const exportDateFormatted = new Date(exportDate).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });

            // Create a comprehensive HTML document for audit
            const auditDocument = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Appraisal - SOC 2 Audit Document</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: white;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .audit-header {
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .audit-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .audit-header .subtitle {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .audit-meta {
            background: #f3f4f6;
            border-left: 4px solid #8b5cf6;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .audit-meta h2 {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            font-size: 14px;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-label {
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 4px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .meta-value {
            color: #1f2937;
            font-weight: 500;
        }
        
        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        
        .section-header {
            font-size: 20px;
            font-weight: 700;
            color: #1e40af;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .competency-item {
            background: #f9fafb;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .competency-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .rating-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .text-content {
            background: white;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.8;
        }
        
        .goal-item {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .goal-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }
        
        .goal-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .goal-detail-item {
            font-size: 14px;
        }
        
        .goal-detail-label {
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 4px;
        }
        
        .manager-section {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .signature-section {
            background: #f9fafb;
            border: 2px solid #d1d5db;
            padding: 20px;
            margin-top: 30px;
            border-radius: 4px;
        }
        
        .signature-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .signature-item:last-child {
            border-bottom: none;
        }
        
        .signature-label {
            font-weight: 600;
            color: #4b5563;
        }
        
        .signature-value {
            color: #1f2937;
            font-weight: 500;
        }
        
        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }
        
        @media print {
            body {
                padding: 20px;
            }
            
            .section {
                page-break-inside: avoid;
            }
            
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="audit-header">
        <h1>Performance Appraisal - Complete Audit Document</h1>
        <div class="subtitle">seedigital.ai Employee Performance Review System</div>
    </div>
    
    <div class="audit-meta">
        <h2>Document Metadata</h2>
        <div class="meta-grid">
            <div class="meta-item">
                <span class="meta-label">Appraisal ID</span>
                <span class="meta-value">${data.appraisalId || 'Not Assigned'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Export Date</span>
                <span class="meta-value">${exportDateFormatted}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Employee Name</span>
                <span class="meta-value">${data.employeeInfo.name || 'Not Provided'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Employee ID</span>
                <span class="meta-value">${data.employeeInfo.id || 'Not Provided'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Department</span>
                <span class="meta-value">${data.employeeInfo.department || 'Not Provided'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Manager Name</span>
                <span class="meta-value">${data.employeeInfo.managerName || 'Not Provided'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Review Period</span>
                <span class="meta-value">${data.employeeInfo.reviewPeriod || 'Not Provided'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Review Date</span>
                <span class="meta-value">${data.employeeInfo.reviewDate || 'Not Provided'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Document Status</span>
                <span class="meta-value">${data.status || 'Draft'}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Last Saved</span>
                <span class="meta-value">${data.savedDate ? new Date(data.savedDate).toLocaleString() : 'Not Saved'}</span>
            </div>
        </div>
    </div>
    
    ${data.competencies && data.competencies.length > 0 ? `
    <div class="section">
        <h2 class="section-header">Core Competencies Assessment</h2>
        ${data.competencies.map((comp, idx) => `
            <div class="competency-item">
                <div class="competency-name">${idx + 1}. ${comp.name || 'Unnamed Competency'}</div>
                <div class="rating-badge">Rating: ${comp.rating || 'Not Rated'}/5</div>
                <div class="text-content">${comp.comments || 'No comments provided.'}</div>
            </div>
        `).join('')}
    </div>
    ` : ''}
    
    <div class="section">
        <h2 class="section-header">Self-Reflection (Previous 6 Months)</h2>
        
        <div style="margin-bottom: 25px;">
            <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Key Achievements</div>
            <div class="text-content">${data.selfReflection.keyAchievements || 'Not provided.'}</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Challenges and Learnings</div>
            <div class="text-content">${data.selfReflection.challengesLearnings || 'Not provided.'}</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Areas for Improvement</div>
            <div class="text-content">${data.selfReflection.areasForImprovement || 'Not provided.'}</div>
        </div>
    </div>
    
    ${data.goals && data.goals.length > 0 ? `
    <div class="section">
        <h2 class="section-header">Performance Goals (Next 6 Months)</h2>
        ${data.goals.map((goal, idx) => `
            <div class="goal-item">
                <div class="goal-title">Goal ${idx + 1}: ${goal.title || 'Untitled Goal'}</div>
                <div class="text-content" style="margin-bottom: 15px;">${goal.description || 'No description provided.'}</div>
                <div class="goal-details">
                    <div class="goal-detail-item">
                        <div class="goal-detail-label">Success Criteria</div>
                        <div>${goal.successCriteria || 'Not specified.'}</div>
                    </div>
                    <div class="goal-detail-item">
                        <div class="goal-detail-label">Target Date</div>
                        <div>${goal.targetDate || 'Not specified.'}</div>
                    </div>
                    <div class="goal-detail-item">
                        <div class="goal-detail-label">Priority</div>
                        <div style="text-transform: capitalize;">${goal.priority || 'Not specified.'}</div>
                    </div>
                </div>
            </div>
        `).join('')}
    </div>
    ` : ''}
    
    <div class="section">
        <h2 class="section-header">Manager Assessment</h2>
        <div class="manager-section">
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Overall Performance Rating</div>
                <div class="rating-badge">${data.managerAssessment.rating || 'Not Rated'}/5</div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Competency Feedback</div>
                <div class="text-content">${data.managerAssessment.competencyFeedback || 'Not provided.'}</div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Strengths</div>
                <div class="text-content">${data.managerAssessment.strengths || 'Not provided.'}</div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Development Areas</div>
                <div class="text-content">${data.managerAssessment.developmentAreas || 'Not provided.'}</div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="font-weight: 600; color: #4b5563; margin-bottom: 8px; font-size: 14px;">Recommendations</div>
                <div class="text-content">${data.managerAssessment.recommendations || 'Not provided.'}</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2 class="section-header">Signatures and Acknowledgment</h2>
        <div class="signature-section">
            <div class="signature-item">
                <span class="signature-label">Manager Signature</span>
                <span class="signature-value">${data.managerAssessment.signature || 'Not signed'}</span>
            </div>
            <div class="signature-item">
                <span class="signature-label">Manager Signature Date</span>
                <span class="signature-value">${data.managerAssessment.signatureDate || 'Not dated'}</span>
            </div>
            <div class="signature-item">
                <span class="signature-label">Employee Acknowledgment</span>
                <span class="signature-value">${data.employeeAcknowledgment.acknowledged ? 'Yes - Acknowledged' : 'Not Acknowledged'}</span>
            </div>
            <div class="signature-item">
                <span class="signature-label">Employee Signature</span>
                <span class="signature-value">${data.employeeAcknowledgment.signature || 'Not signed'}</span>
            </div>
            <div class="signature-item">
                <span class="signature-label">Employee Signature Date</span>
                <span class="signature-value">${data.employeeAcknowledgment.signatureDate || 'Not dated'}</span>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p><strong>Document Generated:</strong> ${exportDateFormatted}</p>
        <p><strong>Appraisal ID:</strong> ${data.appraisalId || 'Not Assigned'}</p>
        <p>This document is a complete record of the performance appraisal and is suitable for SOC 2 audit purposes.</p>
        <p style="margin-top: 10px; font-size: 11px; color: #9ca3af;">seedigital.ai Performance Appraisal System | Confidential Document</p>
    </div>
</body>
</html>
            `;

            // Create a new window with the audit document
            const printWindow = window.open('', '_blank');
            printWindow.document.write(auditDocument);
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            };
            
            // Also download as HTML file
            const blob = new Blob([auditDocument], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Performance_Appraisal_SOC2_Audit_${data.appraisalId || 'UNKNOWN'}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('Audit document exported successfully');
        }
        window.exportForSOC2Audit = exportForSOC2Audit;

        // Save to SharePoint API (requires Microsoft Graph API)
        async function saveToSharePointAPI(jsonData, filename) {
            // This function requires Microsoft Graph API authentication
            // You'll need to implement proper authentication flow
            
            try {
                // Check if user is authenticated
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    // Need to login
                    await loginToMicrosoft();
                    return;
                }

                // Get access token
                const tokenRequest = {
                    scopes: ['Files.ReadWrite.All', 'Sites.ReadWrite.All'],
                    account: accounts[0]
                };

                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                
                // Upload to SharePoint using Microsoft Graph API
                const siteUrl = sharePointConfig.siteUrl;
                const libraryName = sharePointConfig.libraryName;
                const folderId = sharePointConfig.folderId;
                
                // Get the site ID first (required for Graph API)
                const siteIdEndpoint = `https://graph.microsoft.com/v1.0/sites/${encodeURIComponent(siteUrl)}`;
                const siteResponse = await fetch(siteIdEndpoint, {
                    headers: {
                        'Authorization': `Bearer ${response.accessToken}`
                    }
                });
                
                if (!siteResponse.ok) {
                    throw new Error(`Failed to get site ID: ${siteResponse.statusText}`);
                }
                
                const siteData = await siteResponse.json();
                const siteId = siteData.id;
                
                // Construct Graph API endpoint
                // Try to use folder ID first, then fall back to path-based approach
                let graphEndpoint;
                if (folderId) {
                    // Option 1: Try to get folder by ID and upload to it
                    // First, get the drive (document library)
                    const driveEndpoint = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive`;
                    const driveResponse = await fetch(driveEndpoint, {
                        headers: {
                            'Authorization': `Bearer ${response.accessToken}`
                        }
                    });
                    
                    if (driveResponse.ok) {
                        const driveData = await driveResponse.json();
                        const driveId = driveData.id;
                        
                        // Try to upload to folder using folder ID
                        // Format: /sites/{siteId}/drives/{driveId}/items/{folderId}:/{filename}:/content
                        graphEndpoint = `https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/items/${folderId}:/${filename}:/content`;
                    } else {
                        // Fallback to path-based approach
                        const filePath = `${libraryName}/${filename}`;
                        graphEndpoint = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${filePath}:/content`;
                    }
                } else {
                    // Option 2: Use path-based approach (fallback)
                    const filePath = `${libraryName}/${filename}`;
                    graphEndpoint = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${filePath}:/content`;
                }
                
                // Convert JSON data to string for upload
                const jsonString = JSON.stringify(jsonData, null, 2);
                
                const uploadResponse = await fetch(graphEndpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${response.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: jsonString
                });

                if (!uploadResponse.ok) {
                    throw new Error(`SharePoint upload failed: ${uploadResponse.statusText}`);
                }

                return await uploadResponse.json();
            } catch (error) {
                console.error('SharePoint API error:', error);
                throw error;
            }
        }

        // Login to Microsoft
        async function loginToMicrosoft() {
            try {
                const loginRequest = {
                    scopes: ['Files.ReadWrite.All', 'Sites.ReadWrite.All']
                };
                await msalInstance.loginPopup(loginRequest);
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        // Load from SharePoint
        async function loadFromSharePoint() {
            try {
                showSaveStatus('Loading from SharePoint...', 'blue');
                
                // Implement SharePoint file picker or list
                // For now, we'll use a file input as fallback
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        populateAppraisalData(data);
                        showSaveStatus('Loaded successfully!', 'green');
                    }
                };
                input.click();
            } catch (error) {
                console.error('Load error:', error);
                showSaveStatus('Error loading file.', 'red');
            }
        }

        // Populate form with data
        function populateAppraisalData(data) {
            // Employee info
            if (data.employeeInfo) {
                document.getElementById('employeeName').value = data.employeeInfo.name || '';
                document.getElementById('employeeId').value = data.employeeInfo.id || '';
                document.getElementById('department').value = data.employeeInfo.department || '';
                document.getElementById('managerName').value = data.employeeInfo.managerName || '';
                document.getElementById('reviewPeriod').value = data.employeeInfo.reviewPeriod || '';
                document.getElementById('reviewDate').value = data.employeeInfo.reviewDate || '';
            }

            // Competencies
            if (data.competencies && data.competencies.length > 0) {
                initializeCompetencies();
                data.competencies.forEach((comp, idx) => {
                    if (idx < 6) {
                        if (idx >= competencyCount) {
                            addCompetency(comp.name);
                        } else {
                            document.getElementById(`competency-name-${idx}`).value = comp.name || '';
                            setCompetencyRating(idx, parseInt(comp.rating) || 0);
                            document.getElementById(`competency-comments-${idx}`).value = comp.comments || '';
                        }
                    }
                });
            }

            // Self-reflection
            if (data.selfReflection) {
                document.getElementById('keyAchievements').value = data.selfReflection.keyAchievements || '';
                document.getElementById('challengesLearnings').value = data.selfReflection.challengesLearnings || '';
                document.getElementById('areasForImprovement').value = data.selfReflection.areasForImprovement || '';
            }

            // Goals
            if (data.goals && data.goals.length > 0) {
                initializeGoals();
                // Use original function to avoid recursion
                const originalAddGoal = addGoal;
                data.goals.forEach((goal, idx) => {
                    if (idx > 0) originalAddGoal();
                    document.getElementById(`goal-title-${idx}`).value = goal.title || '';
                    document.getElementById(`goal-description-${idx}`).value = goal.description || '';
                    document.getElementById(`goal-success-${idx}`).value = goal.successCriteria || '';
                    document.getElementById(`goal-date-${idx}`).value = goal.targetDate || '';
                    document.getElementById(`goal-priority-${idx}`).value = goal.priority || 'medium';
                });
            }

            // Manager assessment
            if (data.managerAssessment) {
                if (data.managerAssessment.rating) {
                    setManagerRating(parseInt(data.managerAssessment.rating));
                }
                document.getElementById('managerCompetencyFeedback').value = data.managerAssessment.competencyFeedback || '';
                document.getElementById('managerStrengths').value = data.managerAssessment.strengths || '';
                document.getElementById('managerDevelopmentAreas').value = data.managerAssessment.developmentAreas || '';
                document.getElementById('managerRecommendations').value = data.managerAssessment.recommendations || '';
                document.getElementById('managerSignature').value = data.managerAssessment.signature || '';
                document.getElementById('managerSignatureDate').value = data.managerAssessment.signatureDate || '';
            }

            // Employee acknowledgment
            if (data.employeeAcknowledgment) {
                document.getElementById('employeeAcknowledgment').checked = data.employeeAcknowledgment.acknowledged || false;
                document.getElementById('employeeSignature').value = data.employeeAcknowledgment.signature || '';
                document.getElementById('employeeSignatureDate').value = data.employeeAcknowledgment.signatureDate || '';
            }
        }

        // Local storage functions with unique ID
        function saveToLocalStorage() {
            // Ensure Appraisal ID exists before saving
            if (!currentAppraisalId) {
                currentAppraisalId = getAppraisalId();
                document.getElementById('appraisalId').textContent = currentAppraisalId;
            }
            
            const data = collectAppraisalData();
            // Ensure appraisal ID is always in the data
            data.appraisalId = currentAppraisalId;
            data.lastSaved = new Date().toISOString();
            
            // Mark as draft if not complete (auto-save always saves as draft initially)
            const isComplete = checkFormCompletion(data);
            if (!isComplete) {
                data.status = 'draft';
            } else {
                data.status = 'completed';
            }
            
            // Save with unique ID as key
            localStorage.setItem(`appraisal_${currentAppraisalId}`, JSON.stringify(data));
            
            // Also save a list of all appraisal IDs with metadata
            let appraisalList = JSON.parse(localStorage.getItem('appraisal_list') || '[]');
            const existingIndex = appraisalList.findIndex(item => 
                typeof item === 'string' ? item === currentAppraisalId : item.id === currentAppraisalId
            );
            
            const appraisalMetadata = {
                id: currentAppraisalId,
                employeeName: document.getElementById('employeeName').value || '',
                managerName: document.getElementById('managerName').value || '',
                reviewPeriod: document.getElementById('reviewPeriod').value || '',
                lastSaved: data.lastSaved
            };
            
            if (existingIndex >= 0) {
                appraisalList[existingIndex] = appraisalMetadata;
            } else {
                appraisalList.push(appraisalMetadata);
            }
            
            localStorage.setItem('appraisal_list', JSON.stringify(appraisalList));
            
            updateLastSavedTime();
        }

        function loadAppraisalById(appraisalId) {
            const saved = localStorage.getItem(`appraisal_${appraisalId}`);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    populateAppraisalData(data);
                    updateLastSavedTime(data.lastSaved);
                    return true;
                } catch (error) {
                    console.error('Error loading appraisal:', error);
                    return false;
                }
            }
            return false;
        }

        function updateLastSavedTime(isoTime = null) {
            const lastSavedEl = document.getElementById('lastSaved');
            if (isoTime) {
                const savedDate = new Date(isoTime);
                lastSavedEl.textContent = `Last saved: ${savedDate.toLocaleString()}`;
            } else {
                const now = new Date();
                lastSavedEl.textContent = `Last saved: ${now.toLocaleString()}`;
            }
        }

        // Auto-save to localStorage with debouncing
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToLocalStorage();
            }, 1000); // Save 1 second after last change
        }

        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                debouncedSave();
            }
        });

        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' || e.target.type === 'radio') {
                debouncedSave();
            }
        });
        
        // Share appraisal link
        function shareAppraisal() {
            if (!currentAppraisalId) {
                currentAppraisalId = getAppraisalId();
            }
            
            // Save current data before sharing
            saveToLocalStorage();
            
            // Get current page URL
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('id', currentAppraisalId);
            const shareUrl = currentUrl.toString();
            
            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showSaveStatus('Link copied to clipboard!', 'green');
                }).catch(() => {
                    // Fallback for older browsers
                    copyToClipboardFallback(shareUrl);
                });
            } else {
                copyToClipboardFallback(shareUrl);
            }
        }
        
        function copyToClipboardFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showSaveStatus('Link copied to clipboard!', 'green');
            } catch (err) {
                showSaveStatus('Could not copy. Link: ' + text, 'orange');
            }
            document.body.removeChild(textarea);
        }
        
        // Send email notification
        function sendEmailNotification() {
            if (!currentAppraisalId) {
                currentAppraisalId = getAppraisalId();
            }
            
            // Save current data before sharing
            saveToLocalStorage();
            
            // Get current page URL
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('id', currentAppraisalId);
            const shareUrl = currentUrl.toString();
            
            // Get employee and manager names
            const employeeName = document.getElementById('employeeName').value || 'Employee';
            const managerName = document.getElementById('managerName').value || 'Manager';
            
            // Determine who is sending (check if employee or manager sections are filled)
            const employeeFilled = document.getElementById('keyAchievements').value || 
                                    document.getElementById('employeeName').value;
            const managerFilled = document.getElementById('managerSignature').value || 
                                  document.getElementById('managerStrengths').value;
            
            let recipientName, recipientRole, senderRole, subject, body;
            
            if (employeeFilled && !managerFilled) {
                // Employee sending to manager
                recipientName = managerName;
                recipientRole = 'Manager';
                senderRole = 'Employee';
                subject = `Performance Appraisal - ${employeeName} - Ready for Manager Review`;
                body = `Dear ${recipientName},\n\n` +
                       `I have completed my self-assessment for the performance appraisal period.\n\n` +
                       `Please review and complete your manager assessment section using the link below:\n\n` +
                       `${shareUrl}\n\n` +
                       `Appraisal ID: ${currentAppraisalId}\n\n` +
                       `Thank you,\n${employeeName}`;
            } else if (managerFilled || !employeeFilled) {
                // Manager sending to employee (or initial setup)
                recipientName = employeeName;
                recipientRole = 'Employee';
                senderRole = 'Manager';
                subject = `Performance Appraisal - ${employeeName} - Action Required`;
                body = `Dear ${recipientName},\n\n` +
                       `Please complete your performance appraisal using the link below:\n\n` +
                       `${shareUrl}\n\n` +
                       `Appraisal ID: ${currentAppraisalId}\n\n` +
                       `Please fill in your self-assessment and self-reflection sections. Once complete, I will review and complete the manager assessment.\n\n` +
                       `Thank you,\n${managerName}`;
            }
            
            // Create mailto link
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Try to open email client
            window.location.href = mailtoLink;
            
            // Also copy email template to clipboard as fallback
            const emailTemplate = `Subject: ${subject}\n\n${body}`;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(emailTemplate);
            }
            
            showSaveStatus('Email template opened. Link also copied to clipboard.', 'blue');
        }

        // Download file
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Show save status
        function showSaveStatus(message, color) {
            const statusDiv = document.getElementById('saveStatus');
            const statusText = document.getElementById('saveStatusText');
            
            statusDiv.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white`;
            
            if (color === 'green') {
                statusDiv.style.backgroundColor = '#10b981';
            } else if (color === 'blue') {
                statusDiv.style.backgroundColor = '#3b82f6';
            } else if (color === 'orange') {
                statusDiv.style.backgroundColor = '#f59e0b';
            } else if (color === 'red') {
                statusDiv.style.backgroundColor = '#ef4444';
            }
            
            statusText.textContent = message;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>

